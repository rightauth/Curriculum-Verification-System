<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous" />
    <title>เข้าสู่ระบบ KU</title>
    <script type="application/javascript" src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>    
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="menu">
        <a href="index.html"><li>หน้าหลักสูตร</li></a>
        <a href="add_course.html"><li>เพิ่มหลักสูตร</li></a>
    </div>
    <div class="box">
        <div class="box-login">
            <div class="form" style="text-align: center;"><h3>เพิ่มหลักสูตร</h3></div>
            <div id="root"></div>
        </div>
    </div>

    <script>
        // function isLogin(){
        //     let accesstoken = localStorage.getItem("accesstoken");
        //     let datetoken = localStorage.getItem("datetoken");
        //     if (!accesstoken || accesstoken == "null" || ( datetoken && (new Date(Date.now()-datetoken)).getMinutes() >= 15 )){
        //         localStorage.setItem("accesstoken", null);
        //         localStorage.setItem("datetoken", null);
        //         window.location.href = "http://localhost:3000/login.html"
        //     }
        // }
        // isLogin();
    </script>

<script type="text/babel">
        const { PropTypes } = React;
        const rootElement = document.getElementById('root')

        class ExpressionList extends React.Component { 
            constructor(props) {
                super(props);

                this.rerenderParentCallback = this.rerenderParentCallback.bind(this);
                this.state = {
                    categoryList: []
                }
            }

            rerenderParentCallback(event) {
                this.forceUpdate();
            }

            render() { 
                var objList = this.props.objList;
                var views = [];
                for (var x of objList){
                    views.push(<Expression obj={x}/>);
                }

                return (
                    <div className="expressionList" style={{paddingLeft: (this.props.num*15+20)+"px"}}>
                        <AddExpressionForm objList={objList} rerenderParentCallback={this.rerenderParentCallback}/>
                        {views}
                    </div>
                );
            } 
        }

        class Expression extends React.Component { 
            constructor(props) {
                super(props);
            }

            render() { 
                var obj = this.props.obj;
                return (
                    <div className="expression" style={{paddingLeft: "10px"}}>
                        <span class="exp-item">{obj.type=="regex"?"รายวิชา":"กลุ่มรายวิชา"}</span> - <span class="exp-item">{obj.value}</span>
                    </div>
                );
            } 
        }

        class AddExpressionForm extends React.Component { 
            constructor(props) {
                super(props);

                this.state = {
                    type: "regex",
                    value: ""
                }

                this.handleChangeType = this.handleChangeType.bind(this);
                this.handleChangeValue = this.handleChangeValue.bind(this);
                this.addNewExpression = this.addNewExpression.bind(this);
            }

            handleChangeType(event){
                this.setState({type : event.target.value}) 
            }

            handleChangeValue(event){
                this.setState({value : event.target.value}) 
            }

            addNewExpression(event) {
                console.log(this.state)
                var objList = this.props.objList;
                objList.push({
                    type: this.state['type'],
                    value: this.state['value'],
                })
                this.props.rerenderParentCallback();
            }

            render() { 
                var obj = this.props.obj;
                var categoryList = [];
                return (
                    <div className="expression">
                        <span className="form" style={{marginTop:"20px"}}>
                            ประเภท :
                            <select name="type" id="EditType" onChange={this.handleChangeType} style={{width:"120px"}}>
                                <option value="regex">เลขรายวิชา</option>
                                <option value="group">กลุ่มรายวิชา</option>
                            </select>
                            ค่า : <input onChange={this.handleChangeValue} type="text" name="value"/>
                            <input type='button' value='เพิ่มวิชา' onClick={this.addNewExpression} />
                        </span>
                    </div>
                );
            } 
        }

        class Category extends React.Component { 
            constructor(props) {
                super(props);

                this.rerenderParentCallback = this.rerenderParentCallback.bind(this);
                this.removeCategory = this.removeCategory.bind(this);
            }

            rerenderParentCallback(event) {
                this.forceUpdate();
            }

            removeCategory(id){
                const obj = this.props.obj.subCategory.splice(id, 1);
                this.rerenderParentCallback();
                console.log(obj)
            }

            render() { 
                var obj = this.props.obj;
                var categoryList = [];

                if (this.props.num <= 2 && !obj.expression)
                    categoryList.push(<CategoryAddForm 
                                        objList={obj.subCategory} 
                                        subCategory={true} 
                                        num={this.props.num+1}
                                        rerenderParentCallback={this.rerenderParentCallback} />);

                let i=0;
                obj.subCategory.forEach((category) => {
                    categoryList.push(<Category obj={category} 
                                                removeCategory={this.removeCategory} 
                                                id={i} 
                                                num={this.props.num+1} />);
                    i++;
                })
                return (
                    <div className="category" style={{ paddingLeft: this.props.num*15+"px"}}>
                        <div style={{background: "lightgreen", width:"100%"}}>
                            <span style={{display:"inline-block", width:"49%", paddingLeft: "5px"}}>{obj.categoryName}</span>
                            <span style={{display:"inline-block", width:"49%", textAlign:"right"}}>
                                <span>{obj.atLeastCredit}</span>
                                <span style={{paddingLeft: "10px"}}>
                                    <span onClick={() => this.props.removeCategory(this.props.id)}>[X]</span>
                                </span>
                            </span>
                        </div>
                        <div style={{paddingLeft: "10px"}}>
                            {categoryList}
                        </div>
                    </div>
                );
            } 
        }

        class CategoryAddForm extends React.Component { 
            constructor(props) {
                super(props);

                this.state = {
                    categoryName: "",
                    atLeastCredit: 0,
                    expression: null,
                    typeCategory: false
                }

                this.handleChangeName = this.handleChangeName.bind(this);
                this.handleChangeAtLeastCredit = this.handleChangeAtLeastCredit.bind(this);
                this.handleChangeType = this.handleChangeType.bind(this);
                this.addNewCategoryForm = this.addNewCategoryForm.bind(this);
            }


            handleChangeName(event){
                this.setState({categoryName : event.target.value}) 
            }

            handleChangeAtLeastCredit(event){
                this.setState({atLeastCredit : event.target.value}) 
            }

            handleChangeType(event){
                this.setState({typeCategory : event.target.checked})
                console.log(this.state['typeCategory'])
            }

            addNewCategoryForm(event) {
                var objList = this.props.objList;
                if (this.props.subCategory){
                    objList.push({
                        categoryName: this.state['categoryName'],
                        atLeastCredit: this.state['atLeastCredit'],
                        expression: !this.state['typeCategory']?[]:null,
                        subCategory: [],
                    })
                    console.log(this.state['typeCategory'])
                } else {
                    objList.setState({category: [...objList.state['category'], {
                        categoryName: this.state['categoryName'],
                        atLeastCredit: this.state['atLeastCredit'],
                        expression: !this.state['typeCategory']?[]:null,
                        subCategory: [],
                    }]})
                }
                // this.setState({categoryName : "", atLeastCredit: 0})
                // console.log(objList.state['category']);
                this.props.rerenderParentCallback();
            }

            render() { 
                var subCategory = <span>หมวดหมู่ย่อย: <input onChange={this.handleChangeType} type="checkbox" name="typeCategory"/></span>;
                var finalResult = this.props.expression?<span></span>:subCategory;
                return (
                    <div className="categoryAddForm">
                        <span className="form" style={{marginTop:"20px"}}>
                            ชื่อหมวดหมู่ : <input onChange={this.handleChangeName} type="text" name="categoryName"/>
                            จำนวนหน่วยกิตขั้นต่ำ : <input onChange={this.handleChangeAtLeastCredit} type="number" name="atLeastCredit" style={{width:"50px"}}/>
                            
                            {finalResult}
                            
                            <input type='button' value='เพิ่มหมวดหมู่' onClick={this.addNewCategoryForm} />
                        </span>
                    </div>
                );
            } 
        }

        class CategoryList extends React.Component {  
            constructor(props) {
                super(props);

                var addCourseRemember = JSON.parse(localStorage.getItem("add_course_remember"));
                if (addCourseRemember == null || addCourseRemember == "undefined" || addCourseRemember == "null")
                    this.state = {
                        nameDepartment:"",
                        startYear: 2560,
                        category: [],
                        test: "1"
                    }
                else
                    this.state = addCourseRemember;

                this.rerenderParentCallback = this.rerenderParentCallback.bind(this);
                this.handleChangeNameDepartment = this.handleChangeNameDepartment.bind(this);
                this.handleChangeStartYear = this.handleChangeStartYear.bind(this);
                this.removeCategory = this.removeCategory.bind(this);
                this.postNewCourse = this.postNewCourse.bind(this);
            }

            rerenderParentCallback(event) {
                this.forceUpdate();
            }

            handleChangeNameDepartment(event){
                this.setState({nameDepartment: event.target.value});
                localStorage.setItem("add_course_remember", JSON.stringify(this.state));
            }

            handleChangeStartYear(event){
                this.setState({startYear: event.target.value});
            }

            removeCategory(id){
                const obj = this.state['category'].splice(id, 1);
                this.setState({
                    category: this.state['category']
                })
            }

            postNewCourse(){
                console.log(this.state);
            }

            render() { 
                var result = [];
                let i=0;
                this.state['category'].forEach((category) => {
                    result.push(<Category obj={category} id={i} removeCategory={this.removeCategory} num={1} rerenderParentCallback={this.rerenderParentCallback}/>);
                    i++;
                })

                return (
                    <div className="category-list">
                        <span class="form">
                            รหัสภาค : <input type="text" name="nameDepartment" onChange={this.handleChangeNameDepartment}/>
                            ปีที่เริ่มใช้หลักสูตร : <input type="number" name="startYear" min="0" max="10000" step="1" onChange={this.handleChangeStartYear}/>
                        </span>
                        <br/>
                        <br/>
                        <CategoryAddForm objList={this} rerenderParentCallback={this.rerenderParentCallback}/>
                        <span>
                            <hr/>
                            โครงสร้างหลักสูตร (หมวดหมู๋) - {this.state['category'].length}
                            <hr/>
                            {result}
                        </span>
                        <br/>
                        <hr/>
                        <CourseStructure/>
                        <br/>
                        <div style={{width: "100%", textAlign: "right"}}>
                            <input type="button" value="บันทึก" name="postNewCourse" onClick={this.postNewCourse}/>    
                        </div>
                    </div>
                );
            } 
        }


        class CourseStructureForm extends React.Component { 
            constructor(props) {
                super(props);
            }

            render() { 
                var obj = this.props.obj;
                return (
                    <div className="CourseStructureForm" style={{}}>
                        {this.props.name}
                    </div>
                );
            } 
        }

        class CourseStructureYear extends React.Component { 
            constructor(props) {
                super(props);

                this.state = {
                    firstSemester: {},
                    secondSemester: {},
                }
            }

            render() { 
                var obj = this.props.obj;
                return (
                    <div className="CourseStructureYear row" style={{}}>
                        <CourseStructureForm name={"first"} year={this.props.id} />
                        <CourseStructureForm name={"second"} year={this.props.id} />
                    </div>
                );
            } 
        }

        class CourseStructure extends React.Component { 
            constructor(props) {
                super(props);

                this.state = {
                    'numberOfYear': 0,
                    'years': []
                }
                this.handleChangeNumberOfYear = this.handleChangeNumberOfYear.bind(this);
                this.rerenderParentCallback = this.rerenderParentCallback.bind(this);
            }

            rerenderParentCallback(event) {
                this.forceUpdate();
            }

            handleChangeNumberOfYear(event){
                this.setState({numberOfYear: event.target.value<=100?event.target.value:100});
            }

            render() { 
                var obj = this.props.obj;
                var result = [];

                for(let i=0; i<this.state.numberOfYear; i++){
                    result.push(<CourseStructureYear objList={this.state.years} 
                                                     id={i} 
                                                     rerenderParentCallback={this.rerenderParentCallback}/>);
                }

                return (
                    <div className="CourseStructure" style={{}}>
                        <div>
                            ตารางแผนการศึกษา    
                        </div>
                        <div class="form">
                            จำนวนปี : <input type="number" name="numberOfYear" onChange={this.handleChangeNumberOfYear}/>    
                        </div>
                        <div>
                            {result}
                        </div>
                    </div>
                );
            } 
        }

        // Create a function to wrap up your component
        function App(){
            return(
                <div>
                    <CategoryList/>
                </div>
            )
        }
        
    
        // Use the ReactDOM.render to show your component on the browser
        ReactDOM.render(
          <App />,
          rootElement
        )
    </script>
    
</body>
</html>